```shell
# setup steps https://www.digitalocean.com/community/tutorials/how-to-install-elasticsearch-logstash-and-kibana-elastic-stack-on-ubuntu-22-04

The Elastic Stack — formerly known as the ELK Stack — is a collection of open-source software produced by Elastic which allows you to search, analyze, and visualize logs generated from any source in any format, a practice known as centralized logging. Centralized logging can be useful when attempting to identify problems with your servers or applications as it allows you to search through all of your logs in a single place. It’s also useful because it allows you to identify issues that span multiple servers by correlating their logs during a specific time frame.

The Elastic Stack has four main components:

Elasticsearch: a distributed RESTful search engine which stores all of the collected data.
Logstash: the data processing component of the Elastic Stack which sends incoming data to Elasticsearch.
Kibana: a web interface for searching and visualizing logs.
Beats: lightweight, single-purpose data shippers that can send data from hundreds or thousands of machines to either Logstash or Elasticsearch.

sudo apt update && sudo apt install openjdk-17-jdk

wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elastic-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/elastic-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
sudo apt update
sudo apt install elasticsearch

# Configure Elasticsearch (/etc/elasticsearch/elasticsearch.yml)
cluster.name: elk-siem
node.name: elk-node-1
network.host: 0.0.0.0
discovery.type: single-node
xpack.security.enabled: true # Free basic security

# Start Elasticsearch:
sudo systemctl enable elasticsearch && sudo systemctl start elasticsearch
sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: aS4uY=MO11g0ETXtHKCJ
curl -k -u elastic:aS4uY=MO11g0ETXtHKCJ -X GET "https://localhost:9200"



# Step 2 — Installing and Configuring the Kibana Dashboard
sudo apt install kibana
sudo systemctl enable kibana
sudo systemctl start kibana
echo "kibanaadmin:`openssl passwd -apr1`" | sudo tee -a /etc/nginx/htpasswd.users
sudo nano /etc/nginx/sites-available/kibana.sure.com
server {
    listen 80;

    server_name kibana.sure.com;

    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/htpasswd.users;

    location / {
        proxy_pass http://localhost:5601;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
sudo ln -s /etc/nginx/sites-available/kibana.sure.com /etc/nginx/sites-enabled/kibana.sure.com
sudo nginx -t
sudo systemctl reload nginx
sudo ufw allow 'Nginx Full'
sudo /usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system
This tool will reset the password of the [kibana_system] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [kibana_system] user successfully reset.
New value: XDuax2xScHWo7Z2LD*b0


sudo /usr/share/kibana/bin/kibana-verification-code
Your verification code is:  656 314
curl -k -u elastic:aS4uY=MO11g0ETXtHKCJ -X GET "https://localhost:9200/_security/user"
curl -k -u elastic:aS4uY=MO11g0ETXtHKCJ -X POST "https://localhost:9200/_security/role_mapping/kibana_admin" -H "Content-Type: application/json" -d '{
  "roles": ["kibana_admin"],
  "enabled": true,
  "rules": { "field": { "username": "kibana_system" } }
}'

curl -k -u elastic:aS4uY=MO11g0ETXtHKCJ -X POST "https://localhost:9200/_security/user/kibana_admin" -H "Content-Type: application/json" -d '{
  "password": "SecurePass123!",
  "roles": ["kibana_admin"],
  "full_name": "Kibana Admin"
}'


# Installing and Configuring Logstash
Although it’s possible for Beats to send data directly to the Elasticsearch database, it is common to use Logstash to process the data. This will allow you more flexibility to collect data from different sources, transform it into a common format, and export it to another database.

Install Logstash with this command:
After installing Logstash, you can move on to configuring it. Logstash’s configuration files reside in the /etc/logstash/conf.d directory. For more information on the configuration syntax, you can check out the configuration reference that Elastic provides. As you configure the file, it’s helpful to think of Logstash as a pipeline which takes in data at one end, processes it in one way or another, and sends it out to its destination (in this case, the destination being Elasticsearch). A Logstash pipeline has two required elements, input and output, and one optional element, filter. The input plugins consume data from a source, the filter plugins process the data, and the output plugins write the data to a destination
sudo apt install logstash

# Create a configuration file called 02-beats-input.conf where you will set up your Filebeat input:
# Insert the following input configuration. This specifies a beats input that will listen on TCP port 5044.
sudo vim  /etc/logstash/conf.d/02-beats-input.conf

input {
  beats {
    port => 5044
  }
}

sudo vim /etc/logstash/conf.d/30-elasticsearch-output.conf
output {
  if [@metadata][pipeline] {
	elasticsearch {
  	hosts => ["localhost:9200"]
  	manage_template => false
  	index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
  	pipeline => "%{[@metadata][pipeline]}"
	}
  } else {
	elasticsearch {
  	hosts => ["localhost:9200"]
  	manage_template => false
  	index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
	}
  }
}



sudo -u logstash /usr/share/logstash/bin/logstash --path.settings /etc/logstash -t


# Step 4 — Installing and Configuring Filebeat
sudo apt install filebeat
sudo vim /etc/filebeat/filebeat.yml
output.logstash:
  # The Logstash hosts
  hosts: ["localhost:5044"]
#  collects and parses logs created by the system logging service of common Linux distributions.
sudo filebeat modules enable system
sudo filebeat modules list
sudo apt update && sudo apt install rsyslog -y
sudo filebeat setup --pipelines --modules system
sudo vim /etc/filebeat/modules.d/system.yml
sudo filebeat setup --index-management \
  -E output.logstash.enabled=false \
  -E 'output.elasticsearch.hosts=["https://localhost:9200"]' \
  -E 'output.elasticsearch.username="elastic"' \
  -E 'output.elasticsearch.password="aS4uY=MO11g0ETXtHKCJ"' \
  -E 'output.elasticsearch.ssl.verification_mode=none'


sudo filebeat setup --index-management -E output.logstash.enabled=false -E 'output.elasticsearch.hosts=["localhost:9200"]'


# install APM 

curl -L -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.17.2-amd64.deb
sudo dpkg -i apm-server-8.17.2-amd64.deb
output.elasticsearch:
    hosts: ["<es_url>"]
    username: <username>
    password: <password>



# install APM agent 
https://github.com/elastic/apm-agent-php/releases
curl -L -O https://github.com/elastic/apm-agent-php/releases/download/v1.15.0/apm-agent-php_1.15.0_amd64.deb
sudo dpkg -i apm-agent-php_1.15.0_amd64.deb

wget https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.17.3-amd64.deb
sudo dpkg -i elastic-agent-8.17.3-amd64.deb
sudo systemctl enable elastic-agent
sudo systemctl start elastic-agent
```